package test.de.sos.gvc;

import java.awt.Color;
import java.awt.GraphicsEnvironment;
import java.awt.image.BufferedImage;
import java.io.IOException;

import org.junit.Assume;
import org.junit.Test;

import de.sos.gvc.GraphicsItem;
import de.sos.gvc.GraphicsScene;
import de.sos.gvc.GraphicsView;
import de.sos.gvc.rt.ImageRenderTarget.BufferedImageRenderTarget;
import de.sos.gvc.rt.ImageRenderTarget.VolatileImageRenderTarget;
import de.sos.gvc.styles.DrawableStyle;

public class ImageRenderTargetTest {

	@Test
	public void ImgRT_baseTest_BufferedImage() throws IOException {
		final GraphicsScene scene = new GraphicsScene();
		final String[] sideWkts = {
				"POLYGON ((0 150, 25 75, 100 50, 25 25, 0 -50, -25 25, -100 50, -25 75, 0 150))",
				"POLYGON ((-100 200, -89.47368421052632 200, -89.47368421052632 -89.47368421052632, -78.94736842105263 -89.47368421052632, -78.94736842105263 200, -68.42105263157895 200, -68.42105263157895 -89.47368421052632, -57.89473684210526 -89.47368421052632, -57.89473684210526 200, -47.368421052631575 200, -47.368421052631575 -89.47368421052632, -36.84210526315789 -89.47368421052632, -36.84210526315789 200, -26.315789473684205 200, -26.315789473684205 -89.47368421052632, -15.78947368421052 -89.47368421052632, -15.78947368421052 200, -5.263157894736835 200, -5.263157894736835 -89.47368421052632, 5.26315789473685 -89.47368421052632, 5.26315789473685 200, 15.789473684210535 200, 15.789473684210535 -89.47368421052632, 26.31578947368422 -89.47368421052632, 26.31578947368422 200, 36.842105263157904 200, 36.842105263157904 -89.47368421052632, 47.36842105263159 -89.47368421052632, 47.36842105263159 200, 57.894736842105274 200, 57.894736842105274 -89.47368421052632, 68.42105263157896 -89.47368421052632, 68.42105263157896 200, 78.94736842105264 200, 78.94736842105264 -89.47368421052632, 89.47368421052633 -89.47368421052632, 89.47368421052633 200, 100.00000000000001 200, 100 -100, -100 -100, -100 200))",
				"POLYGON ((-100 43.74769457764663, -61.96975285872371 62.30173367760975, -58.17041682036148 62.30173367760975, -58.17041682036148 -69.67908520841019, -57.89376613795646 -80.33474732571007, -57.06381409074142 -86.03836222796016, -55.37163408336407 -88.89247510143858, -52.50829952047215 -90.99963113242346, -47.26576908889709 -92.35521947620803, -38.436001475470306 -92.95462928808557, -38.436001475470306 -97.23349317594983, -97.23349317594983 -97.23349317594983, -97.23349317594983 -92.95462928808557, -88.12707488011803 -92.36905201032829, -82.93987458502397 -91.05496126890446, -80.20103282921431 -89.09074142382885, -78.43969015123571 -86.55477683511619, -77.48524529693839 -80.9249354481741, -77.16709701217263 -69.67908520841019, -77.16709701217263 14.680929546292887, -77.45296938399113 28.697897454813727, -78.31058649944669 36.5916635927702, -79.45407598672077 39.79158981925488, -81.26152711176687 42.01401696790853, -83.61305791220951 43.31427517521209, -86.38878642567317 43.74769457764663, -91.49760236075248 42.85319070453707, -98.26632239026189 40.1696790852084, -100 43.74769457764663))",
		};
		for (final String wkt : sideWkts) {
			final GraphicsItem subItem = GraphicsItem.createFromWKT(wkt);
			final DrawableStyle style = new DrawableStyle();
			style.setFillPaint(Color.green);
			style.setLinePaint(Color.blue);
			subItem.setStyle(style);
			scene.addItem(subItem);
		}
		final BufferedImageRenderTarget rt = new BufferedImageRenderTarget(640, 480, BufferedImage.TYPE_INT_RGB, false);
		rt.clear(Color.RED);
		final GraphicsView gv = new GraphicsView(scene, rt);

		rt.requestRepaint();

		TestUtils.assertEquals("ImgRT_baseTest.png", rt, 0.1f);
	}


	@Test
	public void ImgRT_baseTest_BufferedImage_Fail() throws IOException {
		final GraphicsScene scene = new GraphicsScene();
		final String[] sideWkts = {
				"POLYGON ((0 150, 25 75, 100 50, 25 25, 0 -50, -25 25, -100 50, -25 75, 0 150))",
				"POLYGON ((-100 200, -89.47368421052632 200, -89.47368421052632 -89.47368421052632, -78.94736842105263 -89.47368421052632, -78.94736842105263 200, -68.42105263157895 200, -68.42105263157895 -89.47368421052632, -57.89473684210526 -89.47368421052632, -57.89473684210526 200, -47.368421052631575 200, -47.368421052631575 -89.47368421052632, -36.84210526315789 -89.47368421052632, -36.84210526315789 200, -26.315789473684205 200, -26.315789473684205 -89.47368421052632, -15.78947368421052 -89.47368421052632, -15.78947368421052 200, -5.263157894736835 200, -5.263157894736835 -89.47368421052632, 5.26315789473685 -89.47368421052632, 5.26315789473685 200, 15.789473684210535 200, 15.789473684210535 -89.47368421052632, 26.31578947368422 -89.47368421052632, 26.31578947368422 200, 36.842105263157904 200, 36.842105263157904 -89.47368421052632, 47.36842105263159 -89.47368421052632, 47.36842105263159 200, 57.894736842105274 200, 57.894736842105274 -89.47368421052632, 68.42105263157896 -89.47368421052632, 68.42105263157896 200, 78.94736842105264 200, 78.94736842105264 -89.47368421052632, 89.47368421052633 -89.47368421052632, 89.47368421052633 200, 100.00000000000001 200, 100 -100, -100 -100, -100 200))",
				"POLYGON ((-100 43.74769457764663, -61.96975285872371 62.30173367760975, -58.17041682036148 62.30173367760975, -58.17041682036148 -69.67908520841019, -57.89376613795646 -80.33474732571007, -57.06381409074142 -86.03836222796016, -55.37163408336407 -88.89247510143858, -52.50829952047215 -90.99963113242346, -47.26576908889709 -92.35521947620803, -38.436001475470306 -92.95462928808557, -38.436001475470306 -97.23349317594983, -97.23349317594983 -97.23349317594983, -97.23349317594983 -92.95462928808557, -88.12707488011803 -92.36905201032829, -82.93987458502397 -91.05496126890446, -80.20103282921431 -89.09074142382885, -78.43969015123571 -86.55477683511619, -77.48524529693839 -80.9249354481741, -77.16709701217263 -69.67908520841019, -77.16709701217263 14.680929546292887, -77.45296938399113 28.697897454813727, -78.31058649944669 36.5916635927702, -79.45407598672077 39.79158981925488, -81.26152711176687 42.01401696790853, -83.61305791220951 43.31427517521209, -86.38878642567317 43.74769457764663, -91.49760236075248 42.85319070453707, -98.26632239026189 40.1696790852084, -100 43.74769457764663))",
		};
		for (final String wkt : sideWkts) {
			final GraphicsItem subItem = GraphicsItem.createFromWKT(wkt);
			final DrawableStyle style = new DrawableStyle();
			style.setFillPaint(Color.green);
			style.setLinePaint(Color.blue);
			subItem.setStyle(style);
			scene.addItem(subItem);
		}
		final BufferedImageRenderTarget rt = new BufferedImageRenderTarget(640, 480, BufferedImage.TYPE_INT_RGB, false);
		rt.clear(Color.RED);
		final GraphicsView gv = new GraphicsView(scene, rt);
		gv.setCenter(1, 1);

		rt.requestRepaint();

		TestUtils.assertNotEquals("ImgRT_baseTest.png", rt, 0.1f);
	}


	@Test
	public void ImgRT_baseTest_VolatileImage() throws IOException {
		Assume.assumeFalse("Will fail in Headless mode", GraphicsEnvironment.isHeadless());

		final GraphicsScene scene = new GraphicsScene();
		final String[] sideWkts = {
				"POLYGON ((0 150, 25 75, 100 50, 25 25, 0 -50, -25 25, -100 50, -25 75, 0 150))",
				"POLYGON ((-100 200, -89.47368421052632 200, -89.47368421052632 -89.47368421052632, -78.94736842105263 -89.47368421052632, -78.94736842105263 200, -68.42105263157895 200, -68.42105263157895 -89.47368421052632, -57.89473684210526 -89.47368421052632, -57.89473684210526 200, -47.368421052631575 200, -47.368421052631575 -89.47368421052632, -36.84210526315789 -89.47368421052632, -36.84210526315789 200, -26.315789473684205 200, -26.315789473684205 -89.47368421052632, -15.78947368421052 -89.47368421052632, -15.78947368421052 200, -5.263157894736835 200, -5.263157894736835 -89.47368421052632, 5.26315789473685 -89.47368421052632, 5.26315789473685 200, 15.789473684210535 200, 15.789473684210535 -89.47368421052632, 26.31578947368422 -89.47368421052632, 26.31578947368422 200, 36.842105263157904 200, 36.842105263157904 -89.47368421052632, 47.36842105263159 -89.47368421052632, 47.36842105263159 200, 57.894736842105274 200, 57.894736842105274 -89.47368421052632, 68.42105263157896 -89.47368421052632, 68.42105263157896 200, 78.94736842105264 200, 78.94736842105264 -89.47368421052632, 89.47368421052633 -89.47368421052632, 89.47368421052633 200, 100.00000000000001 200, 100 -100, -100 -100, -100 200))",
				"POLYGON ((-100 43.74769457764663, -61.96975285872371 62.30173367760975, -58.17041682036148 62.30173367760975, -58.17041682036148 -69.67908520841019, -57.89376613795646 -80.33474732571007, -57.06381409074142 -86.03836222796016, -55.37163408336407 -88.89247510143858, -52.50829952047215 -90.99963113242346, -47.26576908889709 -92.35521947620803, -38.436001475470306 -92.95462928808557, -38.436001475470306 -97.23349317594983, -97.23349317594983 -97.23349317594983, -97.23349317594983 -92.95462928808557, -88.12707488011803 -92.36905201032829, -82.93987458502397 -91.05496126890446, -80.20103282921431 -89.09074142382885, -78.43969015123571 -86.55477683511619, -77.48524529693839 -80.9249354481741, -77.16709701217263 -69.67908520841019, -77.16709701217263 14.680929546292887, -77.45296938399113 28.697897454813727, -78.31058649944669 36.5916635927702, -79.45407598672077 39.79158981925488, -81.26152711176687 42.01401696790853, -83.61305791220951 43.31427517521209, -86.38878642567317 43.74769457764663, -91.49760236075248 42.85319070453707, -98.26632239026189 40.1696790852084, -100 43.74769457764663))",
		};
		for (final String wkt : sideWkts) {
			final GraphicsItem subItem = GraphicsItem.createFromWKT(wkt);
			final DrawableStyle style = new DrawableStyle();
			style.setFillPaint(Color.green);
			style.setLinePaint(Color.blue);
			subItem.setStyle(style);
			scene.addItem(subItem);
		}
		final VolatileImageRenderTarget rt = new VolatileImageRenderTarget(640, 480, false);
		rt.clear(Color.RED);
		final GraphicsView gv = new GraphicsView(scene, rt);

		rt.requestRepaint();

		TestUtils.assertEquals("ImgRT_baseTest.png", rt, 2f); //bigger difference to account for the conversion from VolatileImage -> BufferedImage for comparision
	}

}
